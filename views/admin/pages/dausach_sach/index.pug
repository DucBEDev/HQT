extends ../../layouts/default.pug
include ../../mixins/alert.pug
include ../../mixins/currency.pug

block main 
    link(rel="stylesheet", href="/css/admincss/dausach_sach.css")
    +alert-error(3000)
    +alert-success(3000)

    .container-fluid
        // Phần trên: Danh sách đầu sách
        .card.mb-4
            .card-header.py-3.d-flex.flex-row.align-items-center.justify-content-between
                h6.m-0.font-weight-bold.text-primary Danh Sách Đầu Sách
                button.btn.btn-warning#btnUndoTitleBook(class=(isEmptyStack == true ? "disabled-overlay" : "")) Hoàn tác
            .table-responsive.p-3
                table#dataTable.table.align-items-center.table-flush
                    thead.thead-light
                        tr
                            th ISBN
                            th Tên Sách
                            th Kho Sách
                            th Nhà Xuất Bản
                            th Giá
                            th Ngày Xuất Bản
                            th Hành Động
                    tbody#dauSachTableBody
                        each dauSach in dauSachList
                            if (dauSach.isDeleted == false)
                                tr.dau-sach-item(data-isbn=`${dauSach.isbn}`)
                                    td.align-middle #{dauSach.isbn}
                                    td.align-middle #{dauSach.tenSach}
                                    td.align-middle #{dauSach.khoSach}
                                    td.align-middle #{dauSach.nhaXB}
                                    td.align-middle 
                                        +formatCurrency(dauSach.gia)
                                    td.align-middle #{dauSach.ngayXuatBan ? new Date(dauSach.ngayXuatBan).toLocaleDateString('vi-VN') : ''}
                                    td.align-middle
                                        a.btn.btn-sm.btn-dark.select-dau-sach.mr-1(href=`javascript:void(0);` data-isbn=`${dauSach.isbn}`) Chọn
                                        a.btn.btn-sm.btn-danger.delete-dau-sach-btn.mr-1(href=`javascript:void(0);` data-isbn=`${dauSach.isbn}` data-toggle="modal" data-target="#DeleteDauSachModal") Xóa

        .card.mb-4
            .card-header.py-3
                h6.font-weight-bold.text-primary Danh Sách Sách (Đầu sách: <span id="selectedDauSach">Chưa chọn</span>)
            .card-body
                form#addSachForm(action=`` method="post")
                    .d-flex.justify-content-end.mb-2
                        button.btn.btn-primary.btn-small.mr-1(type="button" id="addSachBtn") Thêm
                        button.btn.btn-success.btn-small(type="submit" id="ghiSachBtn") Ghi
                    .table-responsive
                        table.table.align-items-center.table-flush#dataSachTable
                            thead.thead-light
                                tr
                                    th Mã Sách
                                    th Tình Trạng
                                    th Cho Mượn
                                    th Kệ
                                    th Hành Động
                            tbody#sachList
                                
                    // Remove the hidden inputs container since we're using JavaScript arrays directly
                    // #sachInputs
                

        .card.mb-4
            .card-header.py-3
                h6.font-weight-bold.text-primary(id="addTitle") Thêm Đầu Sách Mới
                h6.font-weight-bold.text-primary(id="editTitle" style="display: none;") Chỉnh Sửa Đầu Sách
            .card-body
                form#addDauSachForm(action='' method="post" enctype="multipart/form-data")
                    .row
                        .col-lg-6
                            .form-group
                                label(for="isbn") ISBN <span class="required-text">*</span>
                                input.form-control(type="text" id="isbn" name="isbn" placeholder="Nhập ISBN" required)
                                .invalid-feedback#isbnError Vui lòng nhập ISBN hợp lệ (15 chữ số)
                            .form-group
                                label(for="tenSach") Tên Sách <span class="required-text">*</span>
                                input.form-control(type="text" id="tenSach" name="tenSach" placeholder="Nhập tên sách" required)
                                .invalid-feedback#tenSachError Tên sách không được chứa ký tự đặc biệt
                            .form-group
                                label(for="khoSach") Khổ Sách <span class="required-text">*</span>
                                input.form-control(type="text" id="khoSach" name="khoSach" placeholder="Nhập khổ sách (VD: 16 x 24)" required)
                                .invalid-feedback#khoSachError Khổ sách phải theo định dạng: số x số
                            .form-group
                                label(for="nhaXB") Nhà Xuất Bản <span class="required-text">*</span>
                                input.form-control(type="text" id="nhaXB" name="nhaXB" placeholder="Nhập nhà xuất bản" required)
                                .invalid-feedback#nhaXBError Vui lòng nhập tên nhà xuất bản
                            .form-group
                                label(for="gia") Giá <span class="required-text">*</span>
                                input.form-control(type="number" id="gia" name="gia" placeholder="Nhập giá" min="0" required)
                                .invalid-feedback#giaError Giá phải là số dương
                            .form-group
                                label(for="noiDung") Nội Dung <span class="required-text">*</span>
                                textarea.form-control(id="noiDung" name="noiDung" placeholder="Nhập nội dung" required)
                                .invalid-feedback#noiDungError Vui lòng nhập nội dung sách
                        .col-lg-6
                            .form-group
                                label(for="hinhAnhPath") Hình Ảnh <span class="required-text">*</span>
                                input.form-control(type="file" id="hinhAnhPath" name="hinhAnhPath" accept="image/*" required)
                                .invalid-feedback#hinhAnhError Vui lòng chọn file hình ảnh hợp lệ (jpg, jpeg, png, gif)
                            .form-group
                                label(for="ngayXuatBan") Ngày Xuất Bản <span class="required-text">*</span>
                                input.form-control(type="date" id="ngayXuatBan" name="ngayXuatBan" required)
                                .invalid-feedback#ngayXuatBanError Ngày xuất bản không được lớn hơn ngày hiện tại
                            .form-group
                                label(for="lanXuatBan") Lần Xuất Bản <span class="required-text">*</span>
                                input.form-control(type="text" id="lanXuatBan" name="lanXuatBan" placeholder="Nhập lần xuất bản" required)
                                .invalid-feedback#lanXuatBanError Lần xuất bản phải là số dương
                            .form-group
                                label(for="soTrang") Số Trang <span class="required-text">*</span>
                                input.form-control(type="text" id="soTrang" name="soTrang" placeholder="Nhập số trang" required)
                                .invalid-feedback#soTrangError Số trang phải là số dương
                            .form-group
                                label(for="maNgonNgu") Ngôn Ngữ <span class="required-text">*</span>
                                select.form-control(id="maNgonNgu" name="maNgonNgu" required)
                                    each ngonNgu in ngonNguList
                                        option(value=`${ngonNgu.maNgonNgu}`) #{ngonNgu.ngonNgu}
                            .form-group
                                label(for="maTL") Thể Loại <span class="required-text">*</span>
                                select.form-control(id="maTL" name="maTL" required)
                                    each theLoai in theLoaiList
                                        option(value=`${theLoai.maTL}`) #{theLoai.tenTL}
                            .form-group
                                label(for="maTacGia") Tác Giả <span class="required-text">*</span>
                                select.form-control(id="maTacGia" name="maTacGia" multiple size="5" required)
                                    each tacGia in tacGiaList
                                        option(value=`${tacGia.maTacGia}`) #{tacGia.maTacGia} - #{tacGia.hoTenTG}
                                small.form-text.text-muted Giữ Ctrl (Windows) hoặc Cmd (Mac) để chọn nhiều tác giả
                                .invalid-feedback#maTacGiaError Vui lòng chọn ít nhất một tác giả

                    .d-flex.justify-content-end.mt-3
                        button.btn.btn-primary.mr-2(type="button" id="addDauSachBtn") Thêm
                        button.btn.btn-success(type="button" id="ghiDauSachBtn") Ghi
                        button.btn.btn-warning.mr-2(type="button" id="confirmEditDauSachBtn" style="display: none;") Xác nhận
                        button.btn.btn-secondary(type="button" id="cancelEditDauSachBtn" style="display: none;") Hủy

        .card.mb-4(id="dauSachTempListHeader")
            .card-header.py-3.d-flex.flex-row.align-items-center.justify-content-between
                h6.m-0.font-weight-bold.text-primary Danh Sách Đầu Sách Đã Thêm
            .card-body
                .table-responsive
                    table.table.table-bordered(width="100%" cellspacing="0")
                        thead
                            tr
                                th Hình Ảnh
                                th ISBN 
                                th Tên Sách 
                                th Khổ Sách 
                                th Nhà Xuất Bản
                                th Giá
                                th Nội Dung
                                th Ngày Xuất Bản
                                th Lần Xuất Bản
                                th Số Trang
                                th Ngôn Ngữ
                                th Thể Loại
                                th Tác Giả 
                                th Thao tác

                        tbody#dauSachTempList

                
    // Modal Delete Đầu Sách
    #DeleteDauSachModal.modal.fade(tabindex="-1" role="dialog" aria-labelledby="DeleteDauSachModal" aria-hidden="true")
        .modal-dialog(role="document")
            .modal-content
                .modal-header
                    h5#exampleModalLabelDeleteDauSach.modal-title Xóa Đầu Sách
                    button.close(type="button" data-dismiss="modal" aria-label="Close")
                        span(aria-hidden="true") ×
                .modal-body
                    p Bạn chắc chắn muốn xóa đầu sách này không?
                .modal-footer
                    button.btn.btn-outline-primary(type="button" data-dismiss="modal") Không
                    button#delete-dauSach-link.btn.btn-primary(type="button") Xóa

    // Modal Delete Sách
    #DeleteSachModal.modal.fade(tabindex="-1" role="dialog" aria-labelledby="DeleteSachModal" aria-hidden="true")
        .modal-dialog(role="document")
            .modal-content
                .modal-header
                    h5#exampleModalLabelDeleteSach.modal-title Xóa Sách
                    button.close(type="button" data-dismiss="modal" aria-label="Close")
                        span(aria-hidden="true") ×
                .modal-body
                    p Bạn chắc chắn muốn xóa sách này không?
                .modal-footer
                    button.btn.btn-outline-primary(type="button" data-dismiss="modal") Không
                    button#delete-sach-link.btn.btn-primary(type="button") Xóa

    //- form(
    //-     action=""
    //-     method="post"
    //-     id="delete-sach-form"
    //- )

    //- form(
    //-     action=""
    //-     method="post"
    //-     id="delete-dauSach-form"
    //- )

    script(src="/vendor/jquery/jquery.min.js")
    script(src="/js/validation.js")
    script(src="/js/adminjs/isbn_book.js")
    script(src="https://cdn.jsdelivr.net/npm/flatpickr")

    script.
        flatpickr('#ngayXuatBan', {
            dateFormat: 'd/m/Y',
            allowInput: false,
            maxDate: "today",
            onClose: function(selectedDates, dateStr, instance) {
                if (!dateStr) { 
                    alert('Vui lòng chọn ngày');
                }
            }
        });