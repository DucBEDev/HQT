extends ../../layouts/default.pug
include ../../mixins/alert.pug
include ../../mixins/moment.pug

block main 
    +alert-error(3000)
    +alert-success(3000)

    .col-lg-12
        .card.mb-4
            .card-header.py-3.d-flex.flex-row.align-items-center.justify-content-between
                h6.m-0.font-weight-bold.text-primary Danh Sách Bản Backup
                .d-flex.align-items-center
                    form.restore-point-in-time-form(action="/Library/admin/backup-restore/restore-point-in-time" method="POST").d-flex.align-items-center.mr-3
                        .input-group
                            input.form-control(type="datetime-local" id="datetimeRestore" name="datetimeRestore" required)
                            input.form-control(type="number" id="secondRestore" name="secondRestore" min="0" max="59" placeholder="Giây" required)
                            input(type="hidden" id="formattedDatetimeRestore" name="formattedDatetimeRestore")
                            button.btn.btn-primary(type="submit") Khôi phục đến thời điểm
                    form.create-backup-form(action="/Library/admin/backup-restore/backup" method="POST")
                        input(type="hidden" name="replace" value="0")
                        button.btn.btn-primary.mr-2(type="submit") + Tạo Backup
                    form.delete-all-backups-form(action="/Library/admin/backup-restore/backup" method="POST")
                        input(type="hidden" name="replace" value="1")
                        button.btn.btn-danger(type="submit") Xóa Tất Cả Bản Backup Cũ khi tạo Backup Mới
            
            .table-responsive.p-3
                table#dataTable.table.align-items-center.table-flush
                    thead.thead-light
                        tr
                            th Tên Database
                            th Vị Trí
                            th Thời Điểm Bắt Đầu
                            th Thời Điểm Kết Thúc
                            th Kích Thước (MB)
                            th Chế Độ Backup
                            th Người Thực Hiện
                            th Mô Tả
                            th Hành Động
                    tbody#backupTableBody
                        each backup in backupList
                            tr.backup-item
                                td.align-middle #{backup.database_name}
                                td.align-middle #{backup.position}
                                td.align-middle 
                                    +formatDateTime(backup.backup_start_date)
                                td.align-middle 
                                    +formatDateTime(backup.backup_finish_date)
                                td.align-middle #{backup.BackupSizeMB.toFixed(2)}
                                td.align-middle #{backup.BackupType}
                                td.align-middle #{backup.BackupUser}
                                td.align-middle #{backup.BackupDescription}
                                td.align-middle
                                    form.restore-backup-form(action="/Library/admin/backup-restore/restore" method="POST")
                                        input(type="hidden" name="backupId" value=`${backup.position}`)
                                        button.btn.btn-sm.btn-success(type="submit") Khôi phục

    //- Modal Create Backup
    #CreateBackupModal.modal.fade(tabindex="-1" role="dialog" aria-labelledby="CreateBackupModal" aria-hidden="true")
        .modal-dialog(role="document")
            .modal-content
                .modal-header
                    h5#exampleModalLabelCreateBackup.modal-title Tạo bản backup
                    button.close(type="button" data-dismiss="modal" aria-label="Close")
                        span(aria-hidden="true") ×
                .modal-body
                    p Bạn chắc chắn muốn tạo một bản backup mới không?
                .modal-footer
                    button.btn.btn-outline-primary(type="button" data-dismiss="modal") Không
                    button#create-backup-link.btn.btn-primary(type="button") Tạo

    //- Modal Restore Point in Time
    #RestorePointInTimeModal.modal.fade(tabindex="-1" role="dialog" aria-labelledby="RestorePointInTimeModal" aria-hidden="true")
        .modal-dialog(role="document")
            .modal-content
                .modal-header
                    h5#exampleModalLabelRestorePointInTime.modal-title Khôi phục đến thời điểm
                    button.close(type="button" data-dismiss="modal" aria-label="Close")
                        span(aria-hidden="true") ×
                .modal-body
                    p Bạn chắc chắn muốn khôi phục database đến ngày, giờ, và giây đã chọn không? Hành động này sẽ ghi đè dữ liệu hiện tại.
                .modal-footer
                    button.btn.btn-outline-primary(type="button" data-dismiss="modal") Không
                    button#restore-point-in-time-link.btn.btn-success(type="button") Khôi phục
    
    //- Modal Restore Backup
    #RestoreBackupModal.modal.fade(tabindex="-1" role="dialog" aria-labelledby="RestoreBackupModal" aria-hidden="true")
        .modal-dialog(role="document")
            .modal-content
                .modal-header
                    h5#exampleModalLabelRestoreBackup.modal-title Khôi phục bản backup
                    button.close(type="button" data-dismiss="modal" aria-label="Close")
                        span(aria-hidden="true") ×
                .modal-body
                    p Bạn chắc chắn muốn khôi phục bản backup này không? Hành động này sẽ ghi đè dữ liệu hiện tại.
                .modal-footer
                    button.btn.btn-outline-primary(type="button" data-dismiss="modal") Không
                    button#restore-backup-link.btn.btn-success(type="button") Khôi phục

    //- Modal Delete All Backups
    #DeleteAllBackupsModal.modal.fade(tabindex="-1" role="dialog" aria-labelledby="DeleteAllBackupsModal" aria-hidden="true")
        .modal-dialog(role="document")
            .modal-content
                .modal-header
                    h5#exampleModalLabelDeleteAllBackups.modal-title Xóa Tất Cả Bản Backup
                    button.close(type="button" data-dismiss="modal" aria-label="Close")
                        span(aria-hidden="true") ×
                .modal-body
                    p Bạn chắc chắn muốn xóa tất cả các bản backup và tạo một bản backup mới không? Hành động này không thể hoàn tác.
                .modal-footer
                    button.btn.btn-outline-primary(type="button" data-dismiss="modal") Không
                    button#delete-all-backups-link.btn.btn-danger(type="button") Xóa Tất Cả và Tạo Backup

    script.
        // Handle Create Backup Form Submission
        document.querySelector('.create-backup-form').addEventListener('submit', (e) => {
            e.preventDefault();
            $('#CreateBackupModal').modal('show');
            const createButton = document.getElementById('create-backup-link');
            createButton.onclick = null;
            createButton.onclick = () => {
                e.target.submit();
            };
        });

        // Handle Restore Point-in-Time Form Submission
        document.querySelector('.restore-point-in-time-form').addEventListener('submit', (e) => {
            e.preventDefault();
            // Get the datetime-local input value
            const datetimeInput = document.getElementById('datetimeRestore').value;
            const secondsInput = document.getElementById('secondRestore').value || "00";

            // Format to YYYY-MM-DD hh:mm:ss
             if (datetimeInput) {
                const date = new Date(datetimeInput);
                const seconds = String(secondsInput).padStart(2, '0');
                const formattedDate = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}-${String(date.getDate()).padStart(2, '0')} ${String(date.getHours()).padStart(2, '0')}:${String(date.getMinutes()).padStart(2, '0')}:${seconds}`;
                document.getElementById('formattedDatetimeRestore').value = formattedDate;
            }
            $('#RestorePointInTimeModal').modal('show');
            const restoreButton = document.getElementById('restore-point-in-time-link');
            restoreButton.onclick = null;
            restoreButton.onclick = () => {
                e.target.submit();
            };
        });

        // Handle Delete All Backups Form Submission
        document.querySelector('.delete-all-backups-form').addEventListener('submit', (e) => {
            e.preventDefault();
            $('#DeleteAllBackupsModal').modal('show');
            const deleteButton = document.getElementById('delete-all-backups-link');
            deleteButton.onclick = null;
            deleteButton.onclick = () => {
                e.target.submit();
            };
        });

        // Handle Restore Backup Form Submission
        document.querySelectorAll('.restore-backup-form').forEach(form => {
            form.addEventListener('submit', (e) => {
                e.preventDefault();
                $('#RestoreBackupModal').modal('show');
                const restoreButton = document.getElementById('restore-backup-link');
                restoreButton.onclick = null;
                restoreButton.onclick = () => {
                    form.submit();
                };
            });
        });