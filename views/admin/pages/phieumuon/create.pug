extends ../../layouts/default.pug
include ../../mixins/alert.pug

block main 
    style.
        .reader-search-dropdown {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 1px solid #ddd;
            border-radius: 4px;
            max-height: 300px;
            overflow-y: auto;
            z-index: 1000;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .reader-search-item {
            padding: 10px 15px;
            cursor: pointer;
            border-bottom: 1px solid #f0f0f0;
            transition: background-color 0.2s;
        }

        .reader-search-item:hover {
            background-color: #f8f9fa;
        }

        .reader-search-item:last-child {
            border-bottom: none;
        }

        .reader-info .reader-name {
            font-weight: 500;
            color: #333;
        }

        .reader-info .reader-contact {
            font-size: 0.9em;
            color: #666;
            margin-top: 2px;
        }

    +alert-error(3000)
    +alert-success(3000)

    .container-fluid
        .card.mb-4
            .card-header.py-3.d-flex.flex-row.align-items-center.justify-content-between
                h6.m-0.font-weight-bold.text-primary Tạo Phiếu Mượn
            .card-body
                form#addPhieuMuonForm(action=`${prefixAdmin}/phieumuon/create` method="post")
                    .row
                        .col-lg-12
                            h5 Chọn Sách
                            .row
                                .col-lg-6
                                    .form-group
                                        label(for="sachSearch") Tìm sách
                                        input.form-control(type="text" id="sachSearch" placeholder="Nhập mã sách hoặc tên sách")
                                    .product-list#bookList
                                        each sach in sachList
                                            .product-detail-item(
                                                class=(sach.CHOMUON ? 'disabled' : '')
                                                data-ma-sach=`${sach.MASACH}` 
                                                data-ten-sach=`${sach.TENSACH}` 
                                                data-isbn=`${sach.ISBN}`
                                                data-tinh-trang=`${sach.TINHTRANG}`
                                                style=(sach.CHOMUON ? 'pointer-events: none; opacity: 0.6;' : ''))
                                                    | #{sach.MASACH} - #{sach.TENSACH} #{sach.CHOMUON ? '(Đã được mượn)' : ''}
                                .col-lg-6
                                    .form-group
                                        label Sách đã chọn
                                        .selected-products#selectedBooks
                    hr.separation
                    .row
                        .col-lg-12
                            h5 Thông Tin Phiếu Mượn
                            .form-group
                                label(for="maPhieu") Mã phiếu <span class="required-text">*</span>
                                input.form-control(type="text" value=`${maPhieu}` readonly)
                                input.form-control(type="text" id="maPhieu" name="maPhieu" value=`${maPhieu}` hidden readonly)
                            .form-group.position-relative
                                label(for="maDG") Tên độc giả <span class="required-text">*</span>
                                input.form-control(type="text" id="tenDocGia" name="tenDocGia" required placeholder="Nhập mã độc giả hoặc tên độc giả" autocomplete="off")
                                input.form-control(type="text" id="maDG" name="maDG" required hidden)
                                .reader-search-dropdown#readerSearchDropdown(style="display: none;")
                                    each docGia in docGiaList
                                        .reader-search-item(
                                            data-ma-dg=`${docGia.maDG}`
                                            data-ho-dg=`${docGia.hoDG}`
                                            data-ten-dg=`${docGia.tenDG}`
                                            data-email=`${docGia.emailDG}`
                                            data-sdt=`${docGia.dienThoai}`)
                                                .reader-info
                                                    .reader-name #{docGia.maDG} - #{docGia.hoDG} #{docGia.tenDG}
                                                    .reader-contact #{docGia.emailDG} | SĐT #{docGia.dienThoai}
                            .form-group
                                label(for="hinhThuc") Hình thức mượn <span class="required-text">*</span>
                                select.form-control(id="hinhThuc" name="hinhThuc" required)
                                    option(value="1" selected) Mang về
                                    option(value="0") Tại chỗ
                            .form-group
                                label(for="ngayMuon") Ngày mượn <span class="required-text">*</span>
                                input.form-control(type="text" id="ngayMuon" name="ngayMuon" required readonly)
                            .form-group
                                label(for="maNV") Mã nhân viên tạo phiếu <span class="required-text">*</span>
                                input.form-control(type="text" value=`${empName}` readonly)
                                input.form-control(type="text" id="maNV" name="maNV" value=`${empId}` hidden readonly)
                    .row
                        .col-lg-12
                            #selectedBooksInputs
                    .d-flex.justify-content-end.mt-3
                        button.btn.btn-primary(type="submit") Lưu Phiếu Mượn

    script(src="/vendor/jquery/jquery.min.js")
    script(src="https://cdn.jsdelivr.net/npm/fuse.js@7")
    script(src="/js/validation.js")
    script(src="/js/adminjs/phieumuon.js")
    script(src="https://cdn.jsdelivr.net/npm/flatpickr")

    script.
        // Khởi tạo Flatpickr cho ngày mượn
        flatpickr('#ngayMuon', {
            dateFormat: 'd/m/Y', 
            defaultDate: 'today',
            allowInput: false,
            clickOpens: false
        });